---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHero from '../../components/PageHero.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Card from '../../components/Card.astro';
import ServiceRow from '../../components/ServiceRow.astro';
import CtaBanner from '../../components/CtaBanner.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const szkolenia = await getCollection('szkolenia');
  return szkolenia.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;
const { Content } = await render(entry);

const imageForContent = data.contentImage || data.heroImage.replace('w=1920', 'w=800');
---

<BaseLayout title={`${data.title} - Doris Beauty`}>
  <PageHero
    title={data.title}
    breadcrumb={`<a href="/" class="text-white/60 hover:text-white">Strona Główna</a> / Szkolenia / ${data.title}`}
    backgroundImage={data.heroImage}
  />

  <!-- MAIN CONTENT -->
  <section class="py-28 max-md:py-16">
    <div class="max-w-[1200px] mx-auto px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center fade-in">
        <div class:list={[data.infoGrid ? 'order-1' : 'order-2 md:order-1']}>
          <div class="p-8 md:p-0">
            <span class="block text-[0.75rem] tracking-[0.3em] uppercase text-gray-light mb-4 font-medium">{data.overline}</span>
            <h2 class="mb-6">{data.title}</h2>
            <div class="w-[60px] h-px bg-black my-6"></div>
            <div class="prose-content">
              <Content />
            </div>
            {data.stripePriceId ? (
              <button
                type="button"
                class="inline-block mt-6 px-10 py-4 bg-black text-white font-body text-[0.85rem] font-medium tracking-[0.15em] uppercase transition-all hover:bg-gray-dark hover:-translate-y-[2px] hover:shadow-md cursor-pointer border-none"
                data-checkout-button
                data-price-id={data.stripePriceId}
                data-training-title={data.title}
                data-training-slug={entry.id}
              >
                Kup szkolenie — {data.price} zł
              </button>
            ) : (
              <a href="/kontakt" class="inline-block mt-6 px-10 py-4 bg-black text-white font-body text-[0.85rem] font-medium tracking-[0.15em] uppercase transition-all hover:bg-gray-dark hover:-translate-y-[2px] hover:shadow-md">
                Zapisz się
              </a>
            )}
          </div>
        </div>
        <div class:list={[data.infoGrid ? 'order-2' : 'order-1 md:order-2']}>
          <div class="relative overflow-hidden">
            <img
              src={imageForContent}
              alt={data.title}
              class="w-full h-[500px] max-md:h-[350px] object-cover grayscale-[30%] transition-all hover:grayscale-0 hover:scale-[1.02]"
            />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- OPTIONAL: Info Grid (e.g. Lash PRO "Wymagania") -->
  {data.infoGrid && (
    <section class="py-28 max-md:py-16 bg-cream">
      <div class="max-w-[1200px] mx-auto px-8">
        <SectionHeader
          overline={data.infoGridOverline || ''}
          title={data.infoGridTitle || ''}
          description={data.infoGridDescription}
        />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-16 fade-in">
          {data.infoGrid.map((item) => (
            <div>
              <h3 class="mb-6">{item.title}</h3>
              <p>{item.text}</p>
              {item.text2 && <p class="mt-4">{item.text2}</p>}
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- OPTIONAL: Cards section (e.g. Lash Start "Dla kogo", Marketing "Czego się nauczysz") -->
  {data.cards && (
    <section class="py-28 max-md:py-16 bg-gray-bg">
      <div class="max-w-[1200px] mx-auto px-8">
        <SectionHeader
          overline={data.cardsSectionOverline || ''}
          title={data.cardsSectionTitle || ''}
        />
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 fade-in">
          {data.cards.map((card) => (
            <Card icon={card.icon} title={card.title} description={card.description} />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- PROGRAM -->
  <section class:list={['py-28 max-md:py-16', !data.cards && !data.infoGrid && 'bg-gray-bg']}>
    <div class="max-w-[1200px] mx-auto px-8">
      <SectionHeader
        overline="Program"
        title={data.infoGrid ? 'Program zaawansowany' : 'Program szkolenia'}
      />
      <div class="fade-in">
        {data.program.map((step, i) => (
          <ServiceRow
            number={String(i + 1).padStart(2, '0')}
            title={step.title}
            description={step.description}
            isFirst={i === 0}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <CtaBanner
    title={data.ctaTitle}
    description={data.ctaDescription}
    buttonText={data.stripePriceId ? `Kup szkolenie — ${data.price} zł` : data.ctaButtonText}
    buttonLink="/kontakt"
    stripePriceId={data.stripePriceId}
    trainingTitle={data.title}
    trainingSlug={entry.id}
  />
</BaseLayout>

<style>
  .prose-content :global(p) {
    color: var(--color-gray);
    font-size: 1rem;
    line-height: 1.8;
    font-weight: 300;
    margin-bottom: 1.5rem;
  }
</style>

<script>
  function initCheckout() {
    document.querySelectorAll('[data-checkout-button]').forEach((button) => {
      button.addEventListener('click', async () => {
        const btn = button as HTMLButtonElement;
        const originalText = btn.textContent;
        const priceId = btn.dataset.priceId;
        const trainingTitle = btn.dataset.trainingTitle;
        const trainingSlug = btn.dataset.trainingSlug;

        btn.disabled = true;
        btn.textContent = 'Przekierowuję...';

        try {
          const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceId, trainingTitle, trainingSlug }),
          });
          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error(data.error || 'Nie udało się utworzyć sesji płatności');
          }
        } catch (err) {
          console.error('Checkout error:', err);
          btn.disabled = false;
          btn.textContent = originalText;
          alert('Wystąpił błąd. Spróbuj ponownie lub skontaktuj się z nami.');
        }
      });
    });
  }

  initCheckout();
  document.addEventListener('astro:after-swap', initCheckout);
</script>
